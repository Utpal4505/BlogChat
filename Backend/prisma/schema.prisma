// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url    = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

enum NotificationType {
  LIKE
  COMMENT
  FOLLOW
  MESSAGE
}

enum ReferenceType {
  POST
  COMMENT
  MESSAGE
}

enum RegistrationStatus {
  PENDING
  COMPLETED
}

enum Visibility {
  PRIVATE
  PUBLIC
}

enum Status {
  DRAFT
  PUBLISHED
}

enum UserType {
  VERIFIED
  UNVERIFIED
}

enum BugStatus {
  OPEN
  RESOLVED
  IGNORED
}

enum BugReportQueueStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum PostTagStatus {
  PENDING
  READY
  FAILED
}

model User {
  id                    Int                @id @default(autoincrement())
  name                  String
  email                 String?            @unique
  username              String?            @unique
  password              String? // nullable for OAuth users
  googleId              String? // nullable if not using Google
  avatar                String?
  role                  Role               @default(USER)
  isVerified            Boolean            @default(false)
  bio                   String?
  isDeleted             Boolean            @default(false)
  registration_status   RegistrationStatus @default(PENDING)
  visibility            Visibility         @default(PUBLIC)
  posts                 Post[]             @relation("authorPosts")
  comments              Comment[]
  postLikes             PostLike[]
  sentMessages          Message[]          @relation("sentMessages")
  receivedMessages      Message[]          @relation("receivedMessages")
  sentNotifications     Notification[]     @relation("sentNotifications")
  receivedNotifications Notification[]     @relation("receivedNotifications")
  // followers / followees (self-relation)
  followers             Follow[]           @relation("followee")
  followees             Follow[]           @relation("follower")
  tokens                Token[]
  feedback              Feedback[]
  bookmarkedPosts       BookmarkPost[]
  bugReports            BugReport[]
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  deletedAt             DateTime?

  @@index([username])
}

model EmailVerification {
  id        Int      @id @default(autoincrement())
  email     String
  name      String
  otp       String
  otpExpiry DateTime
  createdAt DateTime @default(now())
}

model Post {
  id           Int            @id @default(autoincrement())
  author       User           @relation("authorPosts", fields: [authorId], references: [id])
  authorId     Int
  title        String
  slug         String?        @unique
  content      String
  coverImage   String?
  commentCount Int            @default(0)
  visibility   Visibility     @default(PUBLIC)
  status       Status         @default(DRAFT)
  publishedAt  DateTime?
  comments     Comment[]
  postLikes    PostLike[]
  postTags     PostTag[]
  postTagStatus PostTagStatus @default(PENDING)
  bookmarks    BookmarkPost[]
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  deletedAt    DateTime?

  @@index([authorId])
  @@index([publishedAt])
  @@index([title])
}

model Comment {
  id        Int       @id @default(autoincrement())
  post      Post      @relation(fields: [postId], references: [id])
  postId    Int
  author    User      @relation(fields: [authorId], references: [id])
  authorId  Int
  content   String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([postId, createdAt])
}

model Follow {
  id         Int      @id @default(autoincrement())
  follower   User     @relation("follower", fields: [followerId], references: [id])
  followerId Int
  followee   User     @relation("followee", fields: [followeeId], references: [id])
  followeeId Int
  createdAt  DateTime @default(now())

  @@unique([followerId, followeeId])
  @@index([followeeId, followerId])
}

model PostLike {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  post      Post     @relation(fields: [postId], references: [id])
  postId    Int
  createdAt DateTime @default(now())

  @@unique([userId, postId])
  @@index([postId])
}

model Message {
  id         Int       @id @default(autoincrement())
  sender     User      @relation("sentMessages", fields: [senderId], references: [id])
  senderId   Int
  receiver   User      @relation("receivedMessages", fields: [receiverId], references: [id])
  receiverId Int
  content    String
  createdAt  DateTime  @default(now())
  readAt     DateTime?

  @@index([receiverId, createdAt])
}

model Tag {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  postTags  PostTag[]
  createdAt DateTime  @default(now())

  @@index([name])
}

model PostTag {
  post   Post @relation(fields: [postId], references: [id])
  postId Int
  tag    Tag  @relation(fields: [tagId], references: [id])
  tagId  Int

  @@id([postId, tagId])
  @@index([tagId])
}

model Notification {
  id            Int              @id @default(autoincrement())
  recipient     User             @relation("receivedNotifications", fields: [recipientId], references: [id])
  recipientId   Int
  actor         User?            @relation("sentNotifications", fields: [actorId], references: [id])
  actorId       Int?
  type          NotificationType @default(LIKE)
  referenceType ReferenceType    @default(POST)
  referenceId   Int
  isRead        Boolean          @default(false)
  createdAt     DateTime         @default(now())

  @@index([recipientId, isRead])
}

model Token {
  id        Int      @id @default(autoincrement())
  userId    Int
  token     String   @unique
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
}

model BugReport {
  id                Int       @id @default(autoincrement())
  githubIssueNumber Int?
  bugType           String
  title             String
  description       String
  page              String?
  customPage        String?
  mood              String?
  userType          UserType
  userId            Int? // nullable if unverified user
  user              User?     @relation(fields: [userId], references: [id])
  attachments       Json? // supports multiple attachments
  verificationScore Float?
  stepsToReproduce  Json?
  metadata          Json
  consoleErrors     Json
  status            BugStatus @default(OPEN)
  queueStatus      BugReportQueueStatus @default(PENDING)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([id, bugType, status])
}

model Feedback {
  id     Int  @id @default(autoincrement())
  user   User @relation(fields: [userId], references: [id])
  userId Int

  // core feedback inputs
  experienceMood String // mood or rating
  liked          String? // optional to avoid forcing text
  issues         String? // optional in case user only praises
  page           String // where feedback came from
  improvement    String? // optional if they just liked something
  hasBug         Boolean @default(false)
  bugDescription String?
  screenshotUrl  Json?
  recommendScore Int?

  // meta data (system-collected)
  metadata Json? // device info, session, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([page])
  @@index([hasBug])
}

model BookmarkPost {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  post      Post     @relation(fields: [postId], references: [id])
  postId    Int
  createdAt DateTime @default(now())

  @@unique([userId, postId])
  @@index([postId])
}
